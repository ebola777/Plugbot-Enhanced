/**
 * <p>Bootstrap file for preparing dependencies.</p>
 * <p>Module loading order: bootstrap.js -> main.js -> app.js.</p>
 * <p>In this module, bootstrapping steps are as follows:
 * <ol>
 *     <li>Check whether the current webpage is a plug.dj room.</li>
 *     <li>Wait for dependencies.</li>
 *     <li>Load external files.</li>
 *     <li>Run app bootstrap file (plugbot/main).</li>
 * </ol>
 * </p>
 *
 * @module plugbot/bootstrap
 * @author ebola777@yahoo.com.tw (Shawn Chang)
 * @copyright Shawn Chang 2013
 * @license MIT
 */

!function(){function removeBookmarkletScript(){var src=document.getElementById("plugbot-js");src&&src.parentElement.removeChild(src)}function isWebPageIntended(){var excludedSitePath,currentDomain=document.domain,currentPath=window.location.pathname;if(DEBUG)return!0;if(currentDomain.toLowerCase()===DOMAIN.toLowerCase()){for(excludedSitePath in excludedWebSitePaths)if(excludedWebSitePaths.hasOwnProperty(excludedSitePath)&&currentPath.toLowerCase()===excludedWebSitePaths[excludedSitePath].toLowerCase())return!1;return!0}return!1}function getUrlWithoutTrailingSlash(url){"/"===url.substr(-1)&&(url=url.substr(0,url.length-1));return url}function getBaseDir(){if(!baseDirUrl){baseDirUrl=PROTOCOL;"public release"===BASE_DIR_TYPE?baseDirUrl+=BASE_DIR_PUBLIC_RELEASE:"public debug"===BASE_DIR_TYPE?baseDirUrl+=BASE_DIR_PUBLIC_DEBUG:"assets debug"===BASE_DIR_TYPE&&(baseDirUrl+=BASE_DIR_ASSETS_DEBUG);return baseDirUrl}return baseDirUrl}function getMainFile(){if(!mainFileUrl){mainFileUrl=getBaseDir()+DIR_SCRIPT;"public release"===BASE_DIR_TYPE?mainFileUrl+=FILE_APP_PUBLIC:"public debug"===BASE_DIR_TYPE?mainFileUrl+=FILE_APP_PUBLIC:"assets debug"===BASE_DIR_TYPE&&(mainFileUrl+=FILE_APP_ASSETS)}return mainFileUrl}function getScript(url,options){$.ajax({url:url,dataType:"script",crossDomain:!0,timeout:options.timeout,cache:DEBUG}).done(options.doneCallback).fail(options.failCallback)}function getCss(url,options){var link,idTimeout;link=$("<link>",{"class":options.class,rel:"stylesheet",type:"text/css",href:url});idTimeout=setTimeout(options.failCallback,options.timeout);link[0].onload=function(){clearTimeout(idTimeout);options.doneCallback()};$(document.head).append(link)}function getConvertedFilePaths(listIn,projectDir){var url,urlProjectPrefixHead,urlProjectPrefixTail,i,listOut=[],baseDir=getBaseDir();for(i=0;i<listIn.length;++i){url=listIn[i];urlProjectPrefixHead=url.substr(0,PROJECT_FILE_PREFIX.length);if(urlProjectPrefixHead===PROJECT_FILE_PREFIX){urlProjectPrefixTail=url.substr(url.length-PROJECT_FILE_PREFIX.length-1);listOut.push(baseDir+projectDir+urlProjectPrefixTail)}else listOut.push(PROTOCOL+url)}return listOut}function configureRequireJS(){var baseDir=getBaseDir(),vendorDir=baseDir+DIR_VENDOR;requirejs.config({paths:{plugbot:getUrlWithoutTrailingSlash(baseDir+DIR_SCRIPT),angular:"https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min",domReady:vendorDir+"requirejs-domready/domReady"},shim:{angular:{exports:"angular"}}})}function loadApp(){var mainFile=getMainFile();configureRequireJS();require(["angular"],function(){require([mainFile],function(){console.info("Plug.bot bootstrapped.")})})}function isFileLoaded(url){return!_.isUndefined(loadedFiles[url])}function onFileDone(url){if(!isFileLoaded(url)){loadedFileCount+=1;loadedFiles[url]=!0;loadedFileCount===totalFileCount&&loadApp()}}function onFileFail(url,options){if(!isAborted){isAborted=!0;options.error=options.error||"Unknown";console.error("Plug.bot failed to load the following file, stopping now.\n\nFile: "+url+"\nError: "+options.error)}}function waitToRetryLoadingFile(url,done){setTimeout(function(){isAborted||isFileLoaded(url)||done()},INTERVAL_RETRY)}function loadScript(url,numRetry){getScript(url,{timeout:TIMEOUT_LOADING,doneCallback:function(){isAborted||onFileDone(url)},failCallback:function(jqXHR){if(!isAborted){numRetry=numRetry||0;numRetry===MAX_RETRY_TIMES?onFileFail(url,{error:jqXHR.status}):waitToRetryLoadingFile(url,function(){loadScript(url,numRetry+1)})}}})}function loadStylesheet(url,numRetry){getCss(url,{timeout:TIMEOUT_LOADING,"class":"plugbot-css",doneCallback:function(){isAborted||onFileDone(url)},failCallback:function(){if(!isAborted){numRetry=numRetry||0;numRetry===MAX_RETRY_TIMES?onFileFail(url,{error:"Timeout"}):waitToRetryLoadingFile(url,function(){loadStylesheet(url,numRetry+1)})}}})}function loadFiles(){var listScripts,listStylesheets,i;listScripts=getConvertedFilePaths(scripts,DIR_SCRIPT);listStylesheets=getConvertedFilePaths(stylesheets,DIR_STYLESHEET);totalFileCount=listScripts.length+listStylesheets.length;for(i=0;i!==listScripts.length;++i)loadScript(listScripts[i]);for(i=0;i!==listStylesheets.length;++i)loadStylesheet(listStylesheets[i]);0===totalFileCount&&loadApp()}function waitDependencies(dependencies,intervalCheck,validationHandler,next){var idChecker,index=0,dependency=dependencies[index];idChecker=setInterval(function(){if(validationHandler(dependency)){index+=1;if(index<dependencies.length)dependency=dependencies[index];else{clearInterval(idChecker);next()}}},intervalCheck)}function waitJavaScriptVariables(next){waitDependencies(requiredJavaScriptVariables,INTERVAL_WAIT_JAVASCRIPT_VARIABLES,function(dependency){return window[dependency]},next)}function waitRequireJSModules(next){waitDependencies(requiredRequireJSModules,INTERVAL_WAIT_REQUIREJS_MODULES,function(dependency){return requirejs.specified(dependency)},next)}function waitWebpageElements(next){waitDependencies(requiredWebPageElements,INTERVAL_WAIT_WEBPAGE_ELEMENTS,function(dependency){return $(dependency).length},next)}function loadDevEnvVars(){DEBUG=!1;BASE_DIR_TYPE="public release";if(window.plugbot&&window.plugbot.dev){DEBUG=window.plugbot.dev.DEBUG||DEBUG;BASE_DIR_TYPE=window.plugbot.dev.BASE_DIR_TYPE||BASE_DIR_TYPE}}function init(){if(isWebPageIntended()){console.info("Initialize Plug.bot.");DEBUG&&console.warn("Plug.bot DEBUG on.");removeBookmarkletScript();waitJavaScriptVariables(function(){waitRequireJSModules(function(){waitWebpageElements(function(){loadFiles()})})})}else console.error("Plug.bot not bootstrapped because the current webpage is not a plug.dj room.")}var DEBUG,BASE_DIR_TYPE,baseDirUrl,mainFileUrl,DOMAIN="plug.dj",PROTOCOL="https://",TIMEOUT_LOADING=5e3,INTERVAL_RETRY=1e3,MAX_RETRY_TIMES=2,INTERVAL_WAIT_JAVASCRIPT_VARIABLES=100,INTERVAL_WAIT_REQUIREJS_MODULES=200,INTERVAL_WAIT_WEBPAGE_ELEMENTS=500,PROJECT_FILE_PREFIX="project!",BASE_DIR_ASSETS_DEBUG="localhost/Plugbot-Enhanced/assets/",BASE_DIR_PUBLIC_DEBUG="localhost/Plugbot-Enhanced/public/",BASE_DIR_PUBLIC_RELEASE="ebola777.github.io/Plugbot-Enhanced/downloads/public/",DIR_SCRIPT="js/",DIR_STYLESHEET="css/",DIR_VENDOR="bower_components/",FILE_APP_ASSETS="main.js",FILE_APP_PUBLIC="main.min.js",excludedWebSitePaths=["/","/dashboard"],requiredJavaScriptVariables=["requirejs","jQuery","_","API"],requiredRequireJSModules=["core"],requiredWebPageElements=["#playback"],scripts=[],stylesheets=["project!style.css"],isAborted=!1,totalFileCount=0,loadedFileCount=0,loadedFiles={};loadDevEnvVars();init()}();define("bootstrap",function(){});