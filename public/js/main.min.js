/**
 * @license
 * Copyright (C) 2013 Shawn
 * This program is licensed under the MIT license.
 */

define("plugbot/controllers/module",["angular"],function(t){return t.module("app.controllers",[])}),define("plugbot/controllers/MainCtrl",["plugbot/controllers/module"],function(t){t.controller("MainCtrl",["$scope","Settings","SiteApi",function(t,e,n){function i(t){var n=!l[t.id];_.isFunction(t.switchEnabled)&&t.switchEnabled(n),l[t.id]=n,e.save()}function o(t){t.switchEnabled(l[t.id])}function a(e){t.mediaUrl=e&&e.url?e.url:null}var r="MainCtrl.mediaLink",l=e.read().main;t.items=[{id:"autoWoot",text:"Auto Woot",init:o,handlerClick:i,switchEnabled:function(t){n.autoWoot(t)}},{id:"autoJoin",text:"Auto Join",init:o,handlerClick:i,switchEnabled:function(t){n.autoJoin(t)}}],t.isExpanded=!1,t.mediaUrl=null,t.handleButtonClick=function(){return"toggle"},t.isEnabled=function(t){return l[t.id]},t.click=function(t){_.isFunction(t.handlerClick)&&t.handlerClick(t)},t.getMediaLink=function(){n.getMedia(a)},_.each(t.items,function(t){_.isFunction(t.init)&&t.init(t)}),n.getMedia(a),n.bindMediaChange(r,function(){t.mediaUrl=null},a),t.$on("$destroy",function(){n.autoWoot(!1),n.autoJoin(!1),n.unbindMediaChange(r)})}])}),define("plugbot/controllers/SettingsCtrl",["plugbot/controllers/module"],function(t){t.controller("SettingsCtrl",["$scope","$window","Settings",function(t,e,n){t.items=[{text:"Reset Settings",click:function(){e.confirm("Reset Settings?\nPlease Reload the Page Immediately after Resetting.")&&n.reset()}}],t.handleButtonClick=function(){return"hide"}}])}),define("plugbot/controllers/index",["plugbot/controllers/MainCtrl","plugbot/controllers/SettingsCtrl"],_.identity),define("plugbot/directives/module",["angular"],function(t){return t.module("app.directives",[])}),define("plugbot/directives/draggable",["plugbot/directives/module","angular"],function(t,e){t.directive("draggable",["$document","$window","DomGeometry","Settings",function(t,n,i,o){return{restrict:"A",scope:{dragGrid:"&"},controller:["$scope",function(t){t.settings=o.read(),t.saveSettings=function(){o.save()}}],link:function(o,a,r){function l(){var t=k.iframe,e=t.css("pointer-events");t.css("pointer-events","none"),M.originalPointerEvents=e}function d(){var t=k.iframe;t.css("pointer-events",M.originalPointerEvents)}function s(){k.id&&M.currentPosition&&(E[k.id]=M.currentPosition,o.saveSettings())}function c(t){a.css("z-index",t)}function u(t,e){var n=e.outerWidth(),i=e.outerHeight();return{left:t.x,top:t.y,right:t.x+n,bottom:t.y+i,width:n,height:i}}function g(t){var e,n,o,r=k.containment,l={x:t.x,y:t.y};return k.grid&&(l.x-=l.x%k.grid[0],l.y-=l.y%k.grid[1]),_.each(k.snap,function(t){var e=i.getSnap(t,u(l,a),k.snapMode,k.snapTolerance);(e.x||e.y)&&(l.x+=e.x,l.y+=e.y)}),r.length&&(e=u(l,a),n=i.isContain(r,e),n.x&&n.y||(o=i.getRestraint(r,e),n.x||(l.x=o.left),n.y||(l.y=o.top))),l}function p(t){var e=!0,n=u(t,a),o=k.containment;return o.length&&(e=i.isContain(o,n)),e&&_.each(k.elemNoOverlap,function(t){e&&(e=!i.isIntersect(t,n))}),e}function f(t){M.currentPosition=t,a.css({left:t.x,top:t.y})}function m(t){var e=g(t);p(e)&&f(e)}function h(){o.$apply(function(){var t,e,n,i=k.elemKeepZoom;i.length&&(t={width:i.width(),height:i.height()},e={width:t.width/M.originalKeepZoomSize.width,height:t.height/M.originalKeepZoomSize.height},n={x:M.currentPosition.x*e.width,y:M.currentPosition.y*e.height},n=g(n),p(n)&&f(n),M.originalKeepZoomSize=t)})}function v(){o.$apply(function(){var t=M.currentMouseOffset,e={x:R.scrollLeft()-S.x,y:R.scrollTop()-S.y},n={x:y.x+t.x+e.x,y:y.y+t.y+e.y};M.currentScrollOffset=e,m(n)})}function b(t){var e=M.currentScrollOffset,n={x:t.clientX-C.x,y:t.clientY-C.y},i={x:y.x+n.x+e.x,y:y.y+n.y+e.y};return M.currentMouseOffset=n,m(i),!1}function x(){return c(M.originalZIndex),d(),s(),R.off("scroll",v),t.off("mousemove",b),t.off("mouseup",x),!1}function w(n){return y={x:a.prop("offsetLeft"),y:a.prop("offsetTop")},C={x:n.clientX,y:n.clientY},S={x:R.scrollLeft(),y:R.scrollTop()},_.extend(k,{containment:e.element(r.dragContainment),iframe:e.element(r.dragIframeFix),snap:e.element(r.dragSnap),elemNoOverlap:e.element(r.dragNoOverlap),elemKeepZoom:e.element(r.dragKeepZoom)}),_.extend(M,{currentMouseOffset:{x:0,y:0},currentScrollOffset:{x:0,y:0},currentPosition:void 0,originalZIndex:a.css("z-index"),originalPointerEvents:void 0}),c(k.zIndex),l(),R.on("scroll",v),t.on("mousemove",b),t.on("mouseup",x),!1}var y,C,S,k,M,E=o.settings.window,R=e.element(n),I=a.find(r.dragHandle);a.css({position:"absolute"}),k={id:r.dragId,zIndex:r.dragZIndex,containment:e.element(r.dragContainment),containmentTolerance:r.dragContainmentTolerance,iframe:e.element(r.dragIframeFix),grid:o.dragGrid(),snap:e.element(r.dragSnap),snapMode:r.dragSnapMode,snapTolerance:r.dragSnapTolerance||8,elemNoOverlap:e.element(r.dragNoOverlap),elemKeepZoom:e.element(r.dragKeepZoom)},k.elemKeepZoom.length&&(M={currentPosition:{x:a.prop("offsetLeft"),y:a.prop("offsetTop")},originalKeepZoomSize:{width:k.elemKeepZoom.width(),height:k.elemKeepZoom.height()}}),E[k.id]&&p(E[k.id])&&f(E[k.id]),R.on("resize",h),I.length||(I=a),I.on("mousedown",function(t){var n,i=e.element(t.target);return i.closest(r.dragCancel).length||(n=w(t)),n}),a.on("$destroy",function(){R.off("resize",h)})}}}])}),define("plugbot/directives/href",["plugbot/directives/module"],function(t){t.directive("href",function(){return{restrict:"A",link:function(t,e,n){function i(){var n=t[o];n?(e.attr("target","_blank"),e.attr("href",n)):_.isFunction(t.getMediaLink)&&t.getMediaLink()}var o=n.href;e.on("click",i),e.on("mouseenter",i),e.on("$destroy",function(){e.off("click",i),e.off("mouseenter",i)})}}})}),define("plugbot/directives/window",["plugbot/directives/module","angular"],function(t,e){t.directive("window",function(){return{restrict:"A",link:function(t,n,i){function o(t,n){var i=e.element(t.data("window-toggle"));i.length&&i[n]()}function a(n){t.$apply(function(){var i,a=e.element(n.target),r=a.data("window-id");r&&t.handleButtonClick&&(i=t.handleButtonClick(r),o(a,i))})}var r,l=n.find(".handle-buttons");i.window&&n[i.window](),l.length&&(r=l.children(),r.length&&r.on("click",a)),n.on("$destroy",function(){r.off("click",a)})}}})}),define("plugbot/directives/index",["plugbot/directives/draggable","plugbot/directives/href","plugbot/directives/window"],_.identity),define("plugbot/services/module",["angular"],function(t){return t.module("app.services",[])}),define("plugbot/services/utils/DomGeometry",["plugbot/services/module","angular"],function(t,e){t.factory("DomGeometry",["$window",function(t){return{isContainRect:function(t,e){var n={x:!1,y:!1};return t.left-e.left<=0&&e.right-t.right<=0&&(n.x=!0),t.top-e.top<=0&&e.bottom-t.bottom<=0&&(n.y=!0),n},isIntersectRect:function(t,e){return t.left-e.right<0&&e.left-t.right<0&&t.top-e.bottom<0&&e.top-t.bottom<0},isContain:function(t,e){var n=this.getBoundingRect(t),i=this.getBoundingRect(e);return this.isContainRect(n,i)},isIntersect:function(t,e){var n=this.getBoundingRect(t),i=this.getBoundingRect(e);return this.isIntersectRect(n,i)},getSnap:function(t,e,n,i){var o,a,r=this.getBoundingRect(t),l=this.getBoundingRect(e),d=["left","right"],s=["top","bottom"],c=[],u={x:0,y:0};for(("inner"===n||"both"===n)&&c.push([0,0],[1,1]),("outer"===n||"both"===n)&&c.push([0,1],[1,0]),o=0;o<c.length;o+=1)a=r[d[c[o][0]]]-l[d[c[o][1]]],Math.abs(a)<=i&&r.top<=l.bottom&&l.top<=r.bottom&&(u.x+=a),a=r[s[c[o][0]]]-l[s[c[o][1]]],Math.abs(a)<=i&&r.left<=l.right&&l.left<=r.right&&(u.y+=a);return u},getRestraint:function(t,e){var n=this.getBoundingRect(t),i=this.getBoundingRect(e),o=this.isContainRect(n,i),a=i;return o.x||(i.left<n.left?(a.left=n.left,a.right=n.left+i.width):(a.right=n.right,a.left=n.right-i.width)),o.y||(i.top<n.top?(a.top=n.top,a.bottom=n.top+i.height):(a.bottom=n.bottom,a.top=n.bottom-i.height)),a},offsetRect:function(t,e){e=_.clone(e),_.defaults(e,{x:0,y:0}),t.left+=e.x,t.right+=e.x,t.top+=e.y,t.bottom+=e.y},getBoundingRect:function(n){var i,o=e.element(t),a=["left","right","top","bottom","width","height"],r={x:o.scrollLeft(),y:o.scrollTop()};return n instanceof e.element?(i=_.pick(n[0].getBoundingClientRect(),a),this.offsetRect(i,r)):n instanceof HTMLElement?(i=_.pick(n.getBoundingClientRect(),a),this.offsetRect(i,r)):i=n,i}}}])}),define("plugbot/services/Export",["plugbot/services/module","angular"],function(t,e){t.factory("Export",["$window","Settings",function(t,n){t.plugbot={version:"2.0.4",dev:{getSiteHighestZIndex:function(){var t=e.element("#audience, #dj-booth, #playback-container, #dj-button, #vote, .app-right"),n={element:null,zIndex:-1};return _.each(t,function(t){var i=e.element(t).css("z-index");i>n.zIndex&&(n={element:t,zIndex:i})}),n}},resetSettings:function(){n.reset()}}}])}),define("plugbot/services/DomInjection",["plugbot/services/module","angular"],function(t,e){t.factory("DomInjection",["$templateCache",function(t){var n=e.element("#app");n.append(t.get("main.tpl.html")),n.append(t.get("settings.tpl.html"))}])}),define("plugbot/services/Settings",["plugbot/services/module"],function(t){t.factory("Settings",["$window",function(t){var e,n="plugbotEnhanced",i=t.localStorage,o={main:{autoWoot:!0,autoJoin:!1},window:{main:{x:70,y:85},settings:{x:80,y:100}}};return{read:function(){var t;return e?t=e:(t=i[n]?JSON.parse(i[n]):this._clone(),e=t),t},save:function(){this._debounceSave()},reset:function(){delete i[n]},_debounceSave:_.debounce(function(){i[n]=JSON.stringify(e)},1e3),_clone:function(){return JSON.parse(JSON.stringify(o))}}}])}),define("plugbot/services/SiteApi",["plugbot/services/module","angular"],function(t,e){t.factory("SiteApi",["$http","$interval","$window",function(t,n,i){var o,a,r,l=i.API;return{woot:function(){var t=this;this.stopWoot(),o=n(function(){var n=e.element("#woot"),i=l.getUser(),o=l.getDJ();o&&o.id!==i.id&&0===i.vote?n.click():t.stopWoot()},1e3)},join:function(){var t=this;this.stopJoin(),a=n(function(){var e=l.djJoin();e||t.stopJoin()},1e3)},getMedia:function(e){var n,i=l.getMedia();i&&(n={},1===i.format?(n.format="youtube",n.url="//www.youtube.com/watch?v="+i.cid,e(n)):(n.format="soundcloud",t.get("//api.soundcloud.com/tracks/"+i.cid+".json?client_id=YOUR_CLIENT_ID").then(function(t){n.url=t.data.permalink_url},function(){n.url=null}).then(function(){e(n)})))},stopWoot:function(){n.cancel(o)},stopJoin:function(){n.cancel(a)},autoWoot:function(t){t?(l.on(l.ADVANCE,this.woot,this),this.woot()):(l.off(l.ADVANCE,this.woot),this.stopWoot())},autoJoin:function(t){t?(l.on(l.WAIT_LIST_UPDATE,this.join,this),this.join()):(l.off(l.WAIT_LIST_UPDATE,this.join),this.stopJoin())},onMediaChange:function(){var t=this;_.each(r,function(e){e.onAdvance(),t.getMedia(e.onResolved)})},bindMediaChange:function(t,e,n){r||(l.on(l.ADVANCE,this.onMediaChange,this),r={}),r[t]={onAdvance:e,onResolved:n}},unbindMediaChange:function(t){t?delete r[t]:(l.off(l.ADVANCE,this.onMediaChange),r={})},destroy:function(){this.autoWoot(!1),this.autoJoin(!1),this.unbindMediaChange()}}}])}),define("plugbot/services/index",["plugbot/services/utils/DomGeometry","plugbot/services/Export","plugbot/services/DomInjection","plugbot/services/Settings","plugbot/services/SiteApi"],_.identity),angular.module("app.views",["main.tpl.html","settings.tpl.html"]),angular.module("main.tpl.html",[]).run(["$templateCache",function(t){t.put("main.tpl.html",'<div class="plugbot-window plugbot-main"\n     data-window\n     data-draggable\n     data-drag-id="main"\n     data-drag-z-index="1000000"\n     data-drag-containment="#app"\n     data-drag-iframe-fix="#yt-frame"\n     data-drag-handle=".handle"\n     data-drag-cancel=".handle-buttons"\n     data-drag-grid="[4, 4]"\n     data-drag-snap=".app-header, #audience, #dj-booth, #playback-container, #dj-button, #vote, .app-right, #footer"\n     data-drag-snap-mode="outer"\n     data-drag-snap-tolerance="8"\n     data-drag-no-overlap=".app-header, #footer"\n     data-drag-keep-zoom="#app"\n     data-ng-controller="MainCtrl">\n    <div class="handle">\n        <span class="title">Plugbot</span>\n        <span class="handle-buttons">\n            <i class="icon icon-settings-white" data-window-id="settings" data-window-toggle=".plugbot-settings"></i>\n            <i class="icon"\n               data-ng-class="{ \'icon-arrow-up\': isExpanded, \'icon-arrow-down\': !isExpanded }"\n               data-ng-click="isExpanded = !isExpanded"></i>\n        </span>\n    </div>\n    <div class="body">\n        <ul>\n            <li class="item"\n                data-ng-repeat="item in items"\n                data-ng-class="{ \'enabled\': isEnabled(item), disabled: !isEnabled(item) }"\n                data-ng-click="click(item)">{{item.text}}</li>\n            <a class="item item-url" data-href="mediaUrl" data-ng-show="isExpanded">Media Link...</a>\n        </ul>\n    </div>\n</div>\n')}]),angular.module("settings.tpl.html",[]).run(["$templateCache",function(t){t.put("settings.tpl.html",'<div class="plugbot-window plugbot-settings"\n     data-window="hide"\n     data-draggable\n     data-drag-id="settings"\n     data-drag-z-index="1000000"\n     data-drag-containment="#app"\n     data-drag-iframe-fix="#yt-frame"\n     data-drag-handle=".handle"\n     data-drag-cancel=".handle-buttons"\n     data-drag-grid="[8, 8]"\n     data-drag-snap="#app"\n     data-drag-snap-mode="inner"\n     data-drag-snap-tolerance="16"\n     data-drag-no-overlap=".app-header, #footer"\n     data-drag-keep-zoom="#app"\n     data-ng-controller="SettingsCtrl">\n    <div class="handle">\n        <span class="title">Settings</span>\n        <span class="handle-buttons">\n            <i class="icon icon-dialog-close" data-window-id="settings" data-window-toggle=".plugbot-settings"></i>\n        </span>\n    </div>\n    <div class="body">\n        <ul>\n            <li class="item"\n                data-ng-repeat="item in items"\n                data-ng-click="item.click()">{{item.text}}</li>\n        </ul>\n    </div>\n</div>\n')}]),define("plugbot/views/index",function(){}),define("plugbot/app",["angular","plugbot/controllers/index","plugbot/directives/index","plugbot/services/index","plugbot/views/index"],function(t){var e=t.module("app",["app.controllers","app.directives","app.services","app.views"]);return e.run(["DomInjection","Export",_.identity]),e}),require(["angular"],function(t){require(["domReady!","plugbot/app"],function(){t.bootstrap(t.element("#app"),["app"])})}),define("main",function(){});