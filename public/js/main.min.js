/**
 * @license
 * Copyright (C) 2013 Shawn
 * This program is licensed under the MIT license.
 */

define("plugbot/controllers/module",["angular"],function(t){return t.module("app.controllers",[])}),define("plugbot/controllers/MainCtrl",["plugbot/controllers/module"],function(t){t.controller("MainCtrl",["$scope","Settings","SiteApi",function(t,n,e){function i(t){var e=!d[t.id];_.isFunction(t.switchEnabled)&&t.switchEnabled(e),d[t.id]=e,n.save()}function o(t){t.switchEnabled(d[t.id])}function a(n){t.mediaUrl=n&&n.url?n.url:null}var r="MainCtrl.mediaLink",d=n.read().main;t.items=[{id:"autoWoot",text:"Auto Woot",init:o,handlerClick:i,switchEnabled:function(t){e.autoWoot(t)}},{id:"autoJoin",text:"Auto Join",init:o,handlerClick:i,switchEnabled:function(t){e.autoJoin(t)}}],t.isExpanded=!1,t.mediaUrl=null,t.handleButtonClick=function(){return"toggle"},t.isEnabled=function(t){return d[t.id]},t.click=function(t){_.isFunction(t.handlerClick)&&t.handlerClick(t)},t.getMediaLink=function(){e.getMedia(a)},_.each(t.items,function(t){_.isFunction(t.init)&&t.init(t)}),e.getMedia(a),e.bindMediaChange(r,function(){t.mediaUrl=null},a),t.$on("$destroy",function(){e.autoWoot(!1),e.autoJoin(!1),e.unbindMediaChange(r)})}])}),define("plugbot/controllers/SettingsCtrl",["plugbot/controllers/module"],function(t){t.controller("SettingsCtrl",["$scope","$window","Settings",function(t,n,e){t.items=[{text:"Reset Settings",click:function(){n.confirm("Reset Settings?\nPlease Reload the Page Immediately after Resetting.")&&e.reset()}}],t.handleButtonClick=function(){return"hide"}}])}),define("plugbot/controllers/index",["plugbot/controllers/MainCtrl","plugbot/controllers/SettingsCtrl"],_.identity),define("plugbot/directives/module",["angular"],function(t){return t.module("app.directives",[])}),define("plugbot/directives/draggable",["plugbot/directives/module","angular"],function(t,n){t.directive("draggable",["$document","$window","DomGeometry","Settings",function(t,e,i,o){return{restrict:"A",scope:{dragGrid:"&"},controller:["$scope",function(t){t.settings=o.read(),t.saveSettings=function(){o.save()}}],link:function(o,a,r){function d(){var t=C.iframe,n=t.css("pointer-events");t.css("pointer-events","none"),k.originalPointerEvents=n}function l(){var t=C.iframe;t.css("pointer-events",k.originalPointerEvents)}function s(){C.id&&k.currentPosition&&(E[C.id]=k.currentPosition,o.saveSettings())}function c(t){a.css("z-index",t)}function u(t,n){var e=n.outerWidth(),i=n.outerHeight();return{left:t.x,top:t.y,right:t.x+e,bottom:t.y+i,width:e,height:i}}function g(t){var n,e,o,r=C.containment,d={x:t.x,y:t.y};return C.grid&&(d.x-=d.x%C.grid[0],d.y-=d.y%C.grid[1]),_.each(C.snap,function(t){var n=i.getSnap(t,u(d,a),C.snapMode,C.snapTolerance);(n.x||n.y)&&(d.x+=n.x,d.y+=n.y)}),r.length&&(n=u(d,a),e=i.isContain(r,n),e.x&&e.y||(o=i.getRestraint(r,n),e.x||(d.x=o.left),e.y||(d.y=o.top))),d}function p(t){var n=!0,e=u(t,a),o=C.containment;return o.length&&(n=i.isContain(o,e)),n&&_.each(C.elemNoOverlap,function(t){n&&(n=!i.isIntersect(t,e))}),n}function f(t){k.currentPosition=t,a.css({left:t.x,top:t.y})}function m(t){var n=g(t);p(n)&&f(n)}function h(){o.$apply(function(){var t,n,e,i=C.elemKeepZoom;i.length&&(t={width:i.width(),height:i.height()},n={width:t.width/k.originalKeepZoomSize.width,height:t.height/k.originalKeepZoomSize.height},e={x:k.currentPosition.x*n.width,y:k.currentPosition.y*n.height},e=g(e),p(e)&&f(e),k.originalKeepZoomSize=t)})}function b(){o.$apply(function(){var t=k.currentMouseOffset,n={x:M.scrollLeft()-S.x,y:M.scrollTop()-S.y},e={x:w.x+t.x+n.x,y:w.y+t.y+n.y};k.currentScrollOffset=n,m(e)})}function v(t){var n=k.currentScrollOffset,e={x:t.clientX-y.x,y:t.clientY-y.y},i={x:w.x+e.x+n.x,y:w.y+e.y+n.y};return k.currentMouseOffset=e,m(i),!1}function x(){c(k.originalZIndex),l(),s(),M.unbind("scroll",b),t.unbind("mousemove",v),t.unbind("mouseup",x)}var w,y,S,C,k,E=o.settings.window,M=n.element(e),R=a.find(r.dragHandle)||a;a.css({position:"absolute"}),C={id:r.dragId,zIndex:r.dragZIndex,containment:n.element(r.dragContainment),containmentTolerance:r.dragContainmentTolerance,iframe:n.element(r.dragIframeFix),grid:o.dragGrid(),snap:n.element(r.dragSnap),snapMode:r.dragSnapMode,snapTolerance:r.dragSnapTolerance||8,elemNoOverlap:n.element(r.dragNoOverlap),elemKeepZoom:n.element(r.dragKeepZoom)},C.elemKeepZoom.length&&(k={currentPosition:{x:a.prop("offsetLeft"),y:a.prop("offsetTop")},originalKeepZoomSize:{width:C.elemKeepZoom.width(),height:C.elemKeepZoom.height()}}),E[C.id]&&p(E[C.id])&&f(E[C.id]),M.bind("resize",h),R.bind("mousedown",function(e){return w={x:a.prop("offsetLeft"),y:a.prop("offsetTop")},y={x:e.clientX,y:e.clientY},S={x:M.scrollLeft(),y:M.scrollTop()},_.extend(C,{containment:n.element(r.dragContainment),iframe:n.element(r.dragIframeFix),snap:n.element(r.dragSnap),elemNoOverlap:n.element(r.dragNoOverlap),elemKeepZoom:n.element(r.dragKeepZoom)}),_.extend(k,{currentMouseOffset:{x:0,y:0},currentScrollOffset:{x:0,y:0},currentPosition:void 0,originalZIndex:a.css("z-index"),originalPointerEvents:void 0}),c(C.zIndex),d(),M.bind("scroll",b),t.bind("mousemove",v),t.bind("mouseup",x),!1}),a.on("$destroy",function(){M.unbind("resize",h)})}}}])}),define("plugbot/directives/href",["plugbot/directives/module"],function(t){t.directive("href",function(){return{restrict:"A",link:function(t,n,e){function i(){var e=t[o];e?(n.attr("target","_blank"),n.attr("href",e)):_.isFunction(t.getMediaLink)&&t.getMediaLink()}var o=e.href;n.bind("click",i),n.bind("mouseenter",i),n.on("$destroy",function(){n.unbind("click",i),n.unbind("mouseenter",i)})}}})}),define("plugbot/directives/window",["plugbot/directives/module","angular"],function(t,n){t.directive("window",function(){return{restrict:"A",link:function(t,e,i){function o(t,e){var i=n.element(t.data("window-toggle"));i.length&&i[e]()}function a(e){t.$apply(function(){var i,a=n.element(e.target),r=a.data("window-id");r&&t.handleButtonClick&&(i=t.handleButtonClick(r),o(a,i))})}var r,d=e.find(".handle-buttons");i.window&&e[i.window](),d.length&&(r=d.children(),r.length&&r.bind("click",a)),e.on("$destroy",function(){r.unbind("click",a)})}}})}),define("plugbot/directives/index",["plugbot/directives/draggable","plugbot/directives/href","plugbot/directives/window"],_.identity),define("plugbot/services/module",["angular"],function(t){return t.module("app.services",[])}),define("plugbot/services/utils/DomGeometry",["plugbot/services/module","angular"],function(t,n){t.factory("DomGeometry",["$window",function(t){return{isContainRect:function(t,n){var e={x:!1,y:!1};return t.left-n.left<=0&&n.right-t.right<=0&&(e.x=!0),t.top-n.top<=0&&n.bottom-t.bottom<=0&&(e.y=!0),e},isIntersectRect:function(t,n){return t.left-n.right<0&&n.left-t.right<0&&t.top-n.bottom<0&&n.top-t.bottom<0},isContain:function(t,n){var e=this.getBoundingRect(t),i=this.getBoundingRect(n);return this.isContainRect(e,i)},isIntersect:function(t,n){var e=this.getBoundingRect(t),i=this.getBoundingRect(n);return this.isIntersectRect(e,i)},getSnap:function(t,n,e,i){var o,a,r=this.getBoundingRect(t),d=this.getBoundingRect(n),l=["left","right"],s=["top","bottom"],c=[],u={x:0,y:0};for(("inner"===e||"both"===e)&&c.push([0,0],[1,1]),("outer"===e||"both"===e)&&c.push([0,1],[1,0]),o=0;o<c.length;o+=1)a=r[l[c[o][0]]]-d[l[c[o][1]]],Math.abs(a)<=i&&r.top<=d.bottom&&d.top<=r.bottom&&(u.x+=a),a=r[s[c[o][0]]]-d[s[c[o][1]]],Math.abs(a)<=i&&r.left<=d.right&&d.left<=r.right&&(u.y+=a);return u},getRestraint:function(t,n){var e=this.getBoundingRect(t),i=this.getBoundingRect(n),o=this.isContainRect(e,i),a=i;return o.x||(i.left<e.left?(a.left=e.left,a.right=e.left+i.width):(a.right=e.right,a.left=e.right-i.width)),o.y||(i.top<e.top?(a.top=e.top,a.bottom=e.top+i.height):(a.bottom=e.bottom,a.top=e.bottom-i.height)),a},offsetRect:function(t,n){n=_.clone(n),_.defaults(n,{x:0,y:0}),t.left+=n.x,t.right+=n.x,t.top+=n.y,t.bottom+=n.y},getBoundingRect:function(e){var i,o=n.element(t),a=["left","right","top","bottom","width","height"],r={x:o.scrollLeft(),y:o.scrollTop()};return e instanceof n.element?(i=_.pick(e[0].getBoundingClientRect(),a),this.offsetRect(i,r)):e instanceof HTMLElement?(i=_.pick(e.getBoundingClientRect(),a),this.offsetRect(i,r)):i=e,i}}}])}),define("plugbot/services/Export",["plugbot/services/module","angular"],function(t,n){t.factory("Export",["$window","Settings",function(t,e){t.plugbot={VERSION:"2.0.3",dev:{getSiteHighestZIndex:function(){var t=n.element("#audience, #dj-booth, #playback-container, #dj-button, #vote, .app-right"),e={element:null,zIndex:-1};return _.each(t,function(t){var i=n.element(t).css("z-index");i>e.zIndex&&(e={element:t,zIndex:i})}),e}},resetSettings:function(){e.reset()}}}])}),define("plugbot/services/DomInjection",["plugbot/services/module","angular"],function(t,n){t.factory("DomInjection",["$templateCache",function(t){var e=n.element("#app");e.append(t.get("main.tpl.html")),e.append(t.get("settings.tpl.html"))}])}),define("plugbot/services/Settings",["plugbot/services/module"],function(t){t.factory("Settings",["$window",function(t){var n,e="plugbotEnhanced",i=t.localStorage,o={main:{autoWoot:!0,autoJoin:!1},window:{main:{x:70,y:85},settings:{x:80,y:100}}};return{read:function(){var t;return n?t=n:(t=i[e]?JSON.parse(i[e]):this._clone(),n=t),t},save:function(){this._debounceSave()},reset:function(){delete i[e]},_debounceSave:_.debounce(function(){i[e]=JSON.stringify(n)},1e3),_clone:function(){return JSON.parse(JSON.stringify(o))}}}])}),define("plugbot/services/SiteApi",["plugbot/services/module","angular"],function(t,n){t.factory("SiteApi",["$http","$interval","$window",function(t,e,i){var o,a,r,d=i.API;return{woot:function(){var t=this;this.stopWoot(),o=e(function(){var e=n.element("#woot"),i=d.getUser(),o=d.getDJ();o&&o.id!==i.id&&0===i.vote?e.click():t.stopWoot()},1e3)},join:function(){var t=this;this.stopJoin(),a=e(function(){var n=d.djJoin();n||t.stopJoin()},1e3)},getMedia:function(n){var e,i=d.getMedia();i&&(e={},1===i.format?(e.format="youtube",e.url="//www.youtube.com/watch?v="+i.cid,n(e)):(e.format="soundcloud",t.get("//api.soundcloud.com/tracks/"+i.cid+".json?client_id=YOUR_CLIENT_ID").then(function(t){e.url=t.data.permalink_url},function(){e.url=null}).then(function(){n(e)})))},stopWoot:function(){e.cancel(o)},stopJoin:function(){e.cancel(a)},autoWoot:function(t){t?(d.on(d.ADVANCE,this.woot,this),this.woot()):(d.off(d.ADVANCE,this.woot),this.stopWoot())},autoJoin:function(t){t?(d.on(d.WAIT_LIST_UPDATE,this.join,this),this.join()):(d.off(d.WAIT_LIST_UPDATE,this.join),this.stopJoin())},onMediaChange:function(){var t=this;_.each(r,function(n){n.onAdvance(),t.getMedia(n.onResolved)})},bindMediaChange:function(t,n,e){r||(d.on(d.ADVANCE,this.onMediaChange,this),r={}),r[t]={onAdvance:n,onResolved:e}},unbindMediaChange:function(t){t?delete r[t]:(d.off(d.ADVANCE,this.onMediaChange),r={})},destroy:function(){this.autoWoot(!1),this.autoJoin(!1),this.unbindMediaChange()}}}])}),define("plugbot/services/index",["plugbot/services/utils/DomGeometry","plugbot/services/Export","plugbot/services/DomInjection","plugbot/services/Settings","plugbot/services/SiteApi"],_.identity),angular.module("app.views",["main.tpl.html","settings.tpl.html"]),angular.module("main.tpl.html",[]).run(["$templateCache",function(t){t.put("main.tpl.html",'<div class="plugbot-window plugbot-main"\n     data-window\n     data-draggable\n     data-drag-id="main"\n     data-drag-z-index="1000000"\n     data-drag-containment="#app"\n     data-drag-iframe-fix="#yt-frame"\n     data-drag-handle=".handle"\n     data-drag-grid="[4, 4]"\n     data-drag-snap=".app-header, #audience, #dj-booth, #playback-container, #dj-button, #vote, .app-right, #footer"\n     data-drag-snap-mode="outer"\n     data-drag-snap-tolerance="8"\n     data-drag-no-overlap=".app-header, #footer"\n     data-drag-keep-zoom="#app"\n     data-ng-controller="MainCtrl">\n    <div class="handle">\n        <span class="title">Plugbot</span>\n        <span class="handle-buttons">\n            <i class="icon icon-settings-white" data-window-id="settings" data-window-toggle=".plugbot-settings"></i>\n            <i class="icon"\n               data-ng-class="{ \'icon-arrow-up\': isExpanded, \'icon-arrow-down\': !isExpanded }"\n               data-ng-click="isExpanded = !isExpanded"></i>\n        </span>\n    </div>\n    <div class="body">\n        <ul>\n            <li class="item"\n                data-ng-repeat="item in items"\n                data-ng-class="{ \'enabled\': isEnabled(item), disabled: !isEnabled(item) }"\n                data-ng-click="click(item)">{{item.text}}</li>\n            <a class="item item-url" data-href="mediaUrl" data-ng-show="isExpanded">Media Link...</a>\n        </ul>\n    </div>\n</div>\n')}]),angular.module("settings.tpl.html",[]).run(["$templateCache",function(t){t.put("settings.tpl.html",'<div class="plugbot-window plugbot-settings"\n     data-window="hide"\n     data-draggable\n     data-drag-id="settings"\n     data-drag-z-index="1000000"\n     data-drag-containment="#app"\n     data-drag-iframe-fix="#yt-frame"\n     data-drag-handle=".handle"\n     data-drag-grid="[8, 8]"\n     data-drag-snap="#app"\n     data-drag-snap-mode="inner"\n     data-drag-snap-tolerance="16"\n     data-drag-no-overlap=".app-header, #footer"\n     data-drag-keep-zoom="#app"\n     data-ng-controller="SettingsCtrl">\n    <div class="handle">\n        <span class="title">Settings</span>\n        <span class="handle-buttons">\n            <i class="icon icon-dialog-close" data-window-id="settings" data-window-toggle=".plugbot-settings"></i>\n        </span>\n    </div>\n    <div class="body">\n        <ul>\n            <li class="item"\n                data-ng-repeat="item in items"\n                data-ng-click="item.click()">{{item.text}}</li>\n        </ul>\n    </div>\n</div>\n')}]),define("plugbot/views/index",function(){}),define("plugbot/app",["angular","plugbot/controllers/index","plugbot/directives/index","plugbot/services/index","plugbot/views/index"],function(t){var n=t.module("app",["app.controllers","app.directives","app.services","app.views"]);return n.run(["DomInjection","Export",_.identity]),n}),require(["angular"],function(t){require(["domReady!","plugbot/app"],function(){t.bootstrap(t.element("#app"),["app"])})}),define("main",function(){});