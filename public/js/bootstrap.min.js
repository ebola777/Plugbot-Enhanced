/**
 * <p>Site bootstrap file, entry file, prepare dependencies.</p>
 * <p>Module loading order: bootstrap.js -> main.js -> app.js.</p>
 * <p>In this module, bootstrapping steps are as follows:
 * <ol>
 *     <li>Check whether the current site is a plug.dj room</li>
 *     <li>Wait for dependencies</li>
 *     <li>Load external files</li>
 *     <li>Run app bootstrap (plugbot/main)</li>
 * </ol>
 * </p>
 *
 * @module plugbot/bootstrap
 * @author ebola777@yahoo.com.tw (Shawn Chang)
 * @copyright Shawn Chang 2013
 * @license MIT
 */

!function(){function removeBookmarkScript(){var src=document.getElementById("plugbot-js");src&&src.parentElement.removeChild(src)}function isSiteValid(){var excludedSitePath,currentDomain=document.domain,currentPath=window.location.pathname,isValid=!0;if(currentDomain.toLowerCase()===DOMAIN.toLowerCase()){for(excludedSitePath in excludedSitePaths)if(excludedSitePaths.hasOwnProperty(excludedSitePath)&&currentPath.toLowerCase()===excludedSitePaths[excludedSitePath].toLowerCase()){isValid=!1;break}}else isValid=!1;return isValid}function getUrlWithoutTrailingSlash(url){"/"===url.substr(-1)&&(url=url.substr(0,url.length-1));return url}function getBaseDir(){if(!baseDirUrl){baseDirUrl=PROTOCOL;"public release"===BASE_DIR_TYPE?baseDirUrl+=BASE_DIR_PUBLIC_RELEASE:"public debug"===BASE_DIR_TYPE?baseDirUrl+=BASE_DIR_PUBLIC_DEBUG:"assets debug"===BASE_DIR_TYPE&&(baseDirUrl+=BASE_DIR_ASSETS_DEBUG);return baseDirUrl}return baseDirUrl}function getMainFile(){if(!mainFileUrl){mainFileUrl=getBaseDir()+DIR_SCRIPT;"public release"===BASE_DIR_TYPE?mainFileUrl+=FILE_APP_PUBLIC:"public debug"===BASE_DIR_TYPE?mainFileUrl+=FILE_APP_PUBLIC:"assets debug"===BASE_DIR_TYPE&&(mainFileUrl+=FILE_APP_ASSETS)}return mainFileUrl}function getScript(url,options){$.ajax({url:url,dataType:"script",crossDomain:!0,timeout:options.timeout,cache:DEBUG}).done(options.doneCallback).fail(options.failCallback)}function getCss(url,options){var link,idTimeout;link=$("<link>",{"class":options.class,rel:"stylesheet",type:"text/css",href:url});idTimeout=setTimeout(options.failCallback,options.timeout);link[0].onload=function(){clearTimeout(idTimeout);options.doneCallback()};$(document.head).append(link)}function convertFilesUrl(listIn,projectDir){var i,url,urlProjectPrefixHead,urlProjectPrefixTail,listOut=[],baseDir=getBaseDir();for(i=0;i<listIn.length;++i){url=listIn[i];urlProjectPrefixHead=url.substr(0,PROJECT_FILE_PREFIX.length);if(urlProjectPrefixHead===PROJECT_FILE_PREFIX){urlProjectPrefixTail=url.substr(url.length-PROJECT_FILE_PREFIX.length-1);listOut.push(baseDir+projectDir+urlProjectPrefixTail)}else listOut.push(PROTOCOL+url)}return listOut}function configureRequireJs(){var baseDir=getBaseDir(),vendorDir=baseDir+DIR_VENDOR;requirejs.config({paths:{plugbot:getUrlWithoutTrailingSlash(baseDir+DIR_SCRIPT),angular:"//ajax.googleapis.com/ajax/libs/angularjs/1.2.23/angular.min",domReady:vendorDir+"requirejs-domready/domReady"},shim:{angular:{exports:"angular"}}})}function loadApp(){var mainFile=getMainFile();configureRequireJs();require(["angular"],function(){require([mainFile],function(){console.info("Plug.bot Bootstrapped.")})})}function isFileLoaded(url){return!_.isUndefined(loadedFiles[url])}function fileDone(url){if(!isFileLoaded(url)){loadedFileCount+=1;loadedFiles[url]=!0;loadedFileCount===totalFileCount&&loadApp()}}function fileFail(url,options){if(!isAborted){isAborted=!0;options.error=options.error||"Unknown";console.error("Plug.bot Failed to Load the File, Stopping Now.\n\nFile: "+url+"\nError: "+options.error)}}function waitToRetryLoadingFile(url,done){setTimeout(function(){isAborted||isFileLoaded(url)||done()},INTERVAL_RETRY)}function loadScript(url,numRetry){getScript(url,{timeout:TIMEOUT_LOADING,doneCallback:function(){isAborted||fileDone(url)},failCallback:function(jqXHR){if(!isAborted){numRetry=numRetry||0;numRetry===MAX_RETRY_TIMES?fileFail(url,{error:jqXHR.status}):waitToRetryLoadingFile(url,function(){loadScript(url,numRetry+1)})}}})}function loadStylesheet(url,numRetry){getCss(url,{timeout:TIMEOUT_LOADING,"class":"plugbot-css",doneCallback:function(){isAborted||fileDone(url)},failCallback:function(){if(!isAborted){numRetry=numRetry||0;numRetry===MAX_RETRY_TIMES?fileFail(url,{error:"Timeout"}):waitToRetryLoadingFile(url,function(){loadStylesheet(url,numRetry+1)})}}})}function loadFiles(){var i,listScripts,listStylesheets;listScripts=convertFilesUrl(scripts,DIR_SCRIPT);listStylesheets=convertFilesUrl(stylesheets,DIR_STYLESHEET);totalFileCount=listScripts.length+listStylesheets.length;for(i=0;i!==listScripts.length;++i)loadScript(listScripts[i]);for(i=0;i!==listStylesheets.length;++i)loadStylesheet(listStylesheets[i]);0===totalFileCount&&loadApp()}function waitCore(next){var id,requiredVariable,requiredVariableIndex=0;requiredVariable=requiredVariables[0];id=setInterval(function(){if(window[requiredVariable]){requiredVariableIndex+=1;if(requiredVariableIndex>=requiredVariables.length){clearInterval(id);next()}else requiredVariable=requiredVariables[requiredVariableIndex]}},INTERVAL_WAIT_CORE)}function waitModule(next){var id=setInterval(function(){if(requirejs.specified(requiredModule)){clearInterval(id);next()}},INTERVAL_WAIT_MODULE)}function waitDoms(next){var id,requiredDom,requiredDomIndex=0;requiredDom=requiredDoms[0];id=setInterval(function(){if($(requiredDom).length){requiredDomIndex+=1;if(requiredDomIndex>=requiredDoms.length){clearInterval(id);next()}else requiredDom=requiredDoms[requiredDomIndex]}},INTERVAL_WAIT_DOM)}function loadDevelopmentVariables(){if(window.plugbot&&window.plugbot.dev){DEBUG=window.plugbot.dev.DEBUG||!1;BASE_DIR_TYPE=window.plugbot.dev.BASE_DIR_TYPE||"public release"}}function initialize(){if(isSiteValid()){console.info("Initialize Plug.bot.");DEBUG&&console.warn("Plug.bot DEBUG on.");removeBookmarkScript();waitCore(function(){waitModule(function(){waitDoms(function(){loadFiles()})})})}else console.error("Plug.bot Not Bootstrapped Because of Wrong Url.")}var DEBUG,BASE_DIR_TYPE,baseDirUrl,mainFileUrl,DOMAIN="plug.dj",PROTOCOL="//",TIMEOUT_LOADING=5e3,INTERVAL_RETRY=1e3,MAX_RETRY_TIMES=2,INTERVAL_WAIT_CORE=100,INTERVAL_WAIT_MODULE=200,INTERVAL_WAIT_DOM=500,PROJECT_FILE_PREFIX="project!",BASE_DIR_ASSETS_DEBUG="localhost/Plugbot-Enhanced/assets/",BASE_DIR_PUBLIC_DEBUG="localhost/Plugbot-Enhanced/public/",BASE_DIR_PUBLIC_RELEASE="ebola777.github.io/files/Plugbot-Enhanced/public/",DIR_SCRIPT="js/",DIR_STYLESHEET="css/",DIR_VENDOR="bower_components/",FILE_APP_ASSETS="main.js",FILE_APP_PUBLIC="main.min.js",isAborted=!1,totalFileCount=0,loadedFileCount=0,loadedFiles={},excludedSitePaths=["/","/dashboard"],requiredVariables=["requirejs","jQuery","_","API"],requiredModule="core",requiredDoms=["#playback"],scripts=[],stylesheets=["project!style.css"];loadDevelopmentVariables();initialize()}();define("bootstrap",function(){});